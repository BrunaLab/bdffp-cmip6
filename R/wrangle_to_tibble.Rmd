---
title: "Read and combine .nc files"
author: "Eric R. Scott"
date: "2021-11-10"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    number_sections: yes
    highlight: kate
    theme:
      version: 4
      bootswatch: flatly

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
library(tidyverse)
library(here)
library(conflicted)
library(stars)

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
```

*Last compiled: `r Sys.Date()`*

# Purpose

For each CMIP6 model, I want a tibble with a single value for each climate variable for each month. These values should be an average of a 3x3 grid cell area with my study site (Biological Dynamics of Forest Fragments Project, BDFFP) roughly at its center.

The center of BDFFP is at about -2.41ºN, -59.83ºE


# Read in files

`read_stars()` automatically combines .nc files with the same dimensions.

```{r}
files <- list.files(here("data_raw", "ssp126", "access_cm2"), pattern = ".nc", full.names = TRUE)
x <- read_stars(files, proxy = FALSE) 
#proxy = TRUE means it only reads metadata.  Doesn't read in files until calculations are performed.
x
#set coordinate reference system?  CMIP documentation say it's WGS84
#From James Michielini:
st_crs(x) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
# st_crs(x) <- "WGS84"

x
```


# Fix the variable names

For some reason the variable names are the file names??  I'll just extract the first part, which is the variable.

```{r}
names(x) <- str_extract(names(x), "^[:alpha:]+(?=_)")
```

# Aggregate

Not all of the CMIP6 models output data at the same resolution.  So I think I need to come up with a polygon of some kind around BDFFP and use it as an area to aggregate over spatially for all models and variables.

For now, I'll use a circle because it's in the [vignette for `stars`](https://r-spatial.github.io/stars/articles/stars1.html#subsetting)

The rough center of BDFFP is at -2.41ºN, -59.833ºE.  This is just from eyeballing a map. I'll go with a 200km radius around that.

```{r}
library(units)

circle <-
  st_point(c(-59.833, -2.41)) %>% 
  st_sfc() %>%
  st_set_crs("WGS84") %>% 
  st_buffer(units::set_units(200, "km")) %>% 
  st_sfc(crs = st_crs(x))

p <- ggplot() +
  geom_stars(data = x[3,,,1]) +
  geom_sf(data = circle, color = "red", fill = NA) +
  geom_sf(data = st_point(c(-59.833, -2.41)) %>% st_sfc() %>%
  st_set_crs("WGS84"))
p
```
```{r}
st_get_dimension_values(x, which = "y")
```


```{r}
x_agg <- 
  aggregate(
    x,
    circle,
    FUN = mean,
    join = st_intersects,
    exact = TRUE
  ) 
x_agg
```

```{r}
p
p + geom_stars(data = x_agg[3,,1])
```

```{r}
x_agg %>% as_tibble() %>% select(-sfc)
```

