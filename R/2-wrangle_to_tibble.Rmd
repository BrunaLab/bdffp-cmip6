---
title: "Read and combine .nc files"
author: "Eric R. Scott"
date: "2021-11-10"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    number_sections: yes
    highlight: kate
    theme:
      version: 4
      bootswatch: flatly

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
library(tidyverse)
library(here)
library(conflicted)
library(stars)
conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
```

*Last compiled: `r Sys.Date()`*

# Purpose

For each CMIP6 model, I want a tibble with a single value for each climate variable for each month. These values should be an average of a 3x3 grid cell area with BDFFP roughtly at its center.


# Read in files

`read_stars()` should automatically combine .nc files with the same dimensions, I think?

```{r}
files <- list.files(here("data_raw", "ssp126", "MRI-ESM2-0"), full.names = TRUE)
x <- read_stars(files, proxy = TRUE)
st_crs(x) <- "WGS84" #set coordinate reference system.  Docs say it's WGS84
x
```

Fix the variable names

```{r}
names(x) <- str_extract(names(x), "^[:alpha:]+(?=_)")
```

# Crop

I'm trying to understand WHY the dimensions are like they are.

```{r}
st_dimensions(x)
st_get_dimension_values(x, which = "x", where = "center") %>% max()
st_get_dimension_values(x, which = "x", where = "start") %>% max()
st_get_dimension_values(x, which = "x", where = "end") %>% max()

359.4375 + 0.5625
```

Ok, so first pixel is *centered* at 0, so last pixel ends where first pixel begins (-0.5626 = 359.4375)

Is there a single pixel that encompasses most of BDFFP?

```{r}
lon_pixels_cen <- st_get_dimension_values(x, which = "x", where = "center")
lon_pixels_start <- st_get_dimension_values(x, which = "x", where = "start")
lon_pixels_end <- st_get_dimension_values(x, which = "x", where = "end")
lon_dist <- lon_pixels_start - (359.4375-59.83) 
lon_pixels_start[which.min(abs(lon_dist))] - 359.4375
lon_pixels_end[which.min(abs(lon_dist))] -359.4375
```

```{r}
lat_pixels_cen <- st_get_dimension_values(x, which = "y", where = "center")
lat_pixels_start <- st_get_dimension_values(x, which = "y", where = "start")
lat_pixels_end <- st_get_dimension_values(x, which = "y", where = "end")
lat_dist <- lat_pixels_start - (-2.41) 
lat_pixels_start[which.min(abs(lat_dist))] 
lat_pixels_end[which.min(abs(lat_dist))]
```

-60.19ºE to -59.06ºE  Not quite I think?  Needs to go more west?
-2.24ºN to -3.36ºN  Yeah, that covers it, but more south than north

## Bounding box method

Find the pixel that encompases the center of BDFFP and get an area 3x3 around it (i.e. with BDFFP in the center pixel)

```{r paged.print=FALSE}
lat_cen <- which.min(abs(lat_dist))
lon_cen <- which.min(abs(lon_dist))

d = st_dimensions(x)
offset = c(d[["x"]]$offset, d[["y"]]$offset)
res = c(d[["x"]]$delta, d[["y"]]$delta)

offset[1] + lon_cen * res[1]
offset[2] + lat_cen * res[2]


bb = st_bbox(c( #I did this sort of by trial and error.  I don't understand.
  xmin = offset[1] + (lon_cen-2) * res[1],
	ymin = offset[2] + (lat_cen+1) * res[2],
	xmax = offset[1] + (lon_cen+1) * res[1],
	ymax = offset[2] + (lat_cen-2) * res[2]
  ), crs = st_crs(x))

```

Two ways to use bounding box, I think.

1. Just crop the pixels, then convert to tibble and aggregate using familiar tidyverse methods:

```{r}
library(tictoc)
tic()
x_cropped <- x[bb]
x_tbl <- x_cropped %>%
  st_as_stars() %>%  #converts to in RAM object
  as_tibble() %>% #converts to tibble
  group_by(time) %>%  #for each time step
  summarize(across(c(hfls, hfss, pr, tas, tasmax, tasmin), mean))
toc()
head(x_tbl)
```

Quite slow, but transparent.

2. Use the `aggregate()` function from `stars` to take a mean, spatially.

```{r}
tic()
x_tbl2 <- 
  aggregate(x, st_as_sfc(bb), FUN = mean, join = st_intersects) %>%
  as_tibble() %>%
  select(-geometry)
toc()
head(x_tbl2)
```

About twice as fast


```{r}
x_slice <- slice(x, index = 1, along = time) #first year

brazil <-raster::getData("GADM", country = "BRA", level = 1) %>% st_as_sf() #get brazil borders

amazonas <- brazil %>% filter(NAME_1 == "Amazonas") #only the state Manaus is in?

x_brazil <- st_crop(x_slice, amazonas) %>% st_as_stars()


ggplot() +
  geom_stars(data = x_brazil) +
  geom_sf(data = st_as_sfc(bb), fill = NA, color = "red") +
  geom_sf(data = st_as_sfc(x_cropped, as_points = TRUE), fill = NA, color = "green") +
  annotate(
    geom = "point",
    x = 360-59.8333,
    y = -2.41,
    shape = "x",
    size = 3,
    color = "red"
  ) +
  # geom_sf(data = amazonas) + #doesn't work because different coordinate systems I think
  coord_sf()

```

x marks the rough center of BDFFP, red is the bounding box, and the green dots mark the pixels over which the data are aggregated.

