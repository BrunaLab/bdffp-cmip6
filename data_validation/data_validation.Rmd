---
title: "Plot and validate CMIP6 downloads"
output: 
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(pointblank)
library(tidyverse)
library(here)
library(patchwork)
library(lubridate)
library(tsibble)
library(units)
library(ggforce) #to get ggplot to work with `units`
library(gt)
library(SPEI)
source(here::here("R", "functions.R"))
theme_set(theme_bw())
# Use `validate_rmd()` here to set options for the
# pointblank validation workflow within R Markdown documents
```

```{r load_index, message=FALSE, warning=FALSE, include=FALSE}
idx <- read_csv(here("metadata", "cmip6_index.csv"))
```

# Check that all models were downloaded

Check that all the directories for the .nc files got made

```{r validate=TRUE}
source_dl <- dir(here("data_raw", "CMIP6"))
source_id <- idx$source_id %>% unique() %>% str_to_lower() %>% str_replace_all("-", "_")
stop_if_not(!any(!source_id %in% source_dl))
```

Check that all the corresponding .csv files exist

```{r validate=TRUE}
csvs <- list.files(here('data'))
stop_if_not(!any(!paste0(source_id, "_data.csv") %in% csvs))
```


```{r read_files, message=FALSE, warning=FALSE, include=FALSE}
#read in all files for CMIP6
df_list <-
  map(list.files(here('data'),
                 pattern = "data\\.csv$",
                 full.names = TRUE),
      read_csv) %>%
  set_names(map(., ~.x$source_id[1]))

# observed data
xa_raw <- read_csv(here("data", "xavier_aggregated.csv"))
xa <- 
  xa_raw %>%
  mutate(date = paste(yearmonth, 1) %>% ymd(),
         month = month(date, label = TRUE)) %>% 
  group_by(month) %>%
  summarize(across(c(pr, starts_with("tas")), mean)) %>%
  mutate(pr = set_units(pr, "mm/month"),
         across(starts_with("tas"), ~set_units(.x, "degC")))
```

```{r filter_time, include=FALSE}
#filter so timespan is consistent
df_list <- 
  df_list %>% map(~{
    .x %>% 
      filter((
        experiment_id == "historical" &
          between(
            time,
            ymd_hms("1850-01-01 12:00:00"),
            ymd_hms("2014-12-31 12:00:00")
          )
      ) |
        (
          experiment_id != "historical" &
            between(
              time,
              ymd_hms("2015-01-01 12:00:00"),
              ymd_hms("2100-12-31 12:00:00")
            )
        ))
    
  })
```

```{r convert, include=FALSE}
df_list <- map(df_list, convert_units)
```

# Calculations

Perform necessary calculations to compare PET and SPEI among models and between models and observed.

For PET, I'm using the "energy-only" method proposed by Milly and Dune (2016) eq. 8:

$$
PET = 0.8(R_n - G)
$$

Except that in their notes, they estimate $R_n -G$ as `hfls` + `hfss` after converting to units of mm/day using the latent heat of vaporazation of water, given by their eq. 2:

$$
L_v(T) = 2.501 - 0.002361T
$$
in MJ/kg

```{r pet, include=FALSE}
df_list <- 
  df_list %>%
  map(~ .x %>% mutate(pet = pet_energy_only(hfls, hfss, tas))) %>% 
  #convert PET to mm/month
  map(~.x %>%
        mutate(pet = pet * set_units(days_in_month(time), "d/month"),
               cb = pr - pet)
  )
```

For the observed data and the CMIP6 data from the same period, I calculate 3-month SPEI using precipitation and PET.  I then use SPEI to categorize months as experiencing mild, moderate, severe, extreme, or no drought.  I compare the frequencies between observed and CMIP6 data with a Chi-squared goodness-of-fit test (p < 0.05 = dissimilar frequencies).

```{r spei, include=FALSE}
df_list <- 
  df_list %>%
  map(calc_spei)

#calc spei for observed
xa_spei <-
  xa_raw %>% 
  mutate(cb = pr - eto,
         date = ymd(paste(yearmonth, "15"))) %>% 
  mutate(spei = as.numeric(
    spei(
      ts(cb, freq = 12, start = c(year(min(date)), month(min(date)))),
      scale = 3,
      ref.start = c(1980, 4),
      ref.end = c(2014, 12)
    )$fitted
  ))
```


```{r count_droughts, include=FALSE}
# categorize and count droughts
xa_drought <- 
  xa_spei %>% 
  filter(!is.na(spei)) %>% 
  filter(between(date, ymd("1980-04-1"), ymd("2014-12-31"))) %>% 
  mutate(category = case_when(
    spei < 0    & spei >= -1    ~ "mild",
    spei < -1   & spei >= -1.5  ~ "moderate",
    spei < -1.5 & spei >= -2    ~ "severe",
    spei < -2                   ~ "extreme",
    TRUE                        ~ "no drought"
  ) %>% as.factor()) %>% 
  mutate(category = fct_reorder(category, spei, .desc = TRUE)) %>% 
  count(category, name = "n_months")

cmip_drought <- 
  df_list %>% 
  map_dfr(~.x %>% 
            filter(!is.na(spei)) %>% 
            filter(between(time, ymd_hms("1980-04-1 00:00:00"), ymd_hms("2014-12-31 24:00:00"))) %>% 
            mutate(category = case_when(
              spei < 0    & spei >= -1    ~ "mild",
              spei < -1   & spei >= -1.5  ~ "moderate",
              spei < -1.5 & spei >= -2    ~ "severe",
              spei < -2                   ~ "extreme",
              TRUE                        ~ "no drought"
            ) %>% factor(levels = c("mild", "moderate", "severe", "extreme", "no drought"))) %>% 
            mutate(category = fct_reorder(category, spei, .desc = TRUE)) %>% 
            count(category, name = "n_months", .drop = FALSE),
          .id = "source_id"
  ) 

# join together
cmip_drought <- 
  bind_rows(
  xa_drought %>%
    add_column(source_id = "observed", .before = "category"),
  cmip_drought
) %>% 
  mutate(source_id = fct_inorder(source_id)) %>% 
  group_by(source_id) %>% 
  mutate(prop_months = n_months / sum(n_months)) %>% 
  ungroup()
```

```{r chisq, include=FALSE}
#chisq tests
obs <- xa_drought$n_months
cmip_chisq <- 
  cmip_drought %>% 
  group_by(source_id) %>% 
  summarize(chisq = chisq.test(n_months,
                               p = obs, 
                               rescale.p = TRUE,
                               simulate.p.value = TRUE)$p.value)
```

```{r mini_hist, include=FALSE}
#mini histograms
ulim <- max(cmip_drought$prop_months)
drought_plots <-
  cmip_drought%>%  
  mutate(prop_droughts = n_months/sum(obs)) %>% 
  group_by(source_id) %>%
  nest() %>% 
  mutate(
    prop_droughts = map(data, ~{
      ggplot(.x, aes(x = category, fill = category, y = prop_months)) +
        geom_col(color = "black") +
        scale_fill_manual(values = c("no drought" = "blue",
                                     "mild" =  "#ffffb2",
                                     "moderate" = "#fecc5c",
                                     "severe" = "#fd8d3c",
                                     "extreme" =  "#e31a1c")) +
        scale_y_continuous("prop. months", limits = c(0, ulim)) +
        labs(x = expression("drought severity \u2192")) +
        theme(text = element_text(size = 45),
              legend.position = "none",
              axis.text.x = element_blank())
    })) %>% 
  select(-data)
```


# Comparison to Observed Historical


```{r include=FALSE}
season_df <- 
  df_list %>% 
  map_dfr(~{.x %>% 
    filter(time >= ymd("1980-01-01") &
             time <= ymd("2015-09-30")) %>% 
      mutate(month = month(time), .after=time) %>% 
      group_by(month) %>% 
      summarize(across(c(pr, starts_with("tas")), mean,
                       .names = "mean_{.col}")) 
  }, .id = "source_id")
```


```{r include=FALSE}
xa2 <- xa %>% 
  rename_with(~paste0("mean_", .), .cols = -month) %>% 
  add_column(source_id = "observed") %>% 
  mutate(month = as.numeric(month))
season_df <- bind_rows(xa2, season_df) %>% 
  #move "observed" to the top by making it the first level
  mutate(source_id = fct_inorder(source_id))
```


```{r mini_plots, include=FALSE}
# Create mini plots of monthly average precip and temperature for table

# season_df$mean_pr %>% range()
# season_df$mean_tasmin %>% min()
# season_df$mean_tasmax %>% max()

season_plots <-
  season_df %>%  
  group_by(source_id) %>%
  nest() %>% 
  mutate(
    pr_season = map(data, ~{
      ggplot(.x, aes(x = month, y = mean_pr)) +
        geom_col(fill = "blue") +
        scale_x_continuous("month", breaks = 1:12,
                           labels = ~month(.x, label = FALSE)) +
        scale_y_unit("pr", limits = c(0, 456)) +
        theme(text = element_text(size = 45))
    }),
    tas_season = map(data, ~{
      ggplot(.x, aes(x = month)) +
        geom_ribbon(aes(ymin = mean_tasmin, ymax = mean_tasmax),
                    fill = "red",
                    alpha = 0.5) +
        geom_line(aes(y = mean_tas), color = "red") +
        scale_x_continuous("month",
                           breaks = 1:12,
                           labels = ~ month(.x, label = FALSE)) +
        scale_y_unit("tas", limits = c(19, 43)) +
        theme(text = element_text(size = 45))
    })) %>% 
      select(-data)
```




```{r gt_rough, include=FALSE}
table_rough <-
  season_df %>%
  group_by(source_id) %>%
  summarize(
    pr_cor = cor(mean_pr, xa$pr, method = "spearman"),
    tas_cor = cor(mean_tas, xa$tas, method = "spearman"),
    tasmin_cor = cor(mean_tasmin, xa$tasmin, method = "spearman"),
    tasmax_cor = cor(mean_tasmax, xa$tasmax, method = "spearman")
  ) %>%
  full_join(cmip_chisq, by = "source_id") %>% 
  #make columns for plots to go eventually
  mutate(pr_plot = NA,
         tas_plot = NA,
         drought_hist = NA) %>%
  #make into gt
  gt() %>%
  #place plots
  text_transform(
    locations = cells_body(pr_plot),
    fn = function(x) {
      map(season_plots$pr_season,
          ggplot_image,
          height = px(80),
          aspect_ratio = 1.5)
    }
  ) %>% 
  text_transform(
    locations = cells_body(tas_plot),
    fn = function(x) {
      map(season_plots$tas_season,
          ggplot_image,
          height = px(80),
          aspect_ratio = 1.5)
    }
  ) %>% 
  text_transform(
    locations = cells_body(drought_hist),
    fn = function(x) {
      map(drought_plots$prop_droughts,
          ggplot_image,
          height = px(80),
          aspect_ratio = 1.5)
    }
  ) %>% 
  # round correlations
  fmt_number(ends_with("_cor")) %>% 
  fmt_number(chisq, decimals = 3)
```

```{r gt_format, echo=FALSE}
table_rough %>% 
  # highlight poor correlations
  tab_style(
    style = list(
      cell_text(color = "red")
    ),
    locations = cells_body(
      columns = pr_cor,
      rows = pr_cor < 0.45
    )
  ) %>% 
    tab_style(
    style = list(
      cell_text(color = "red")
    ),
    locations = cells_body(
      columns = tas_cor,
      rows = tas_cor < 0.45
    )
  )  %>% 
  tab_style(
    style = list(
      cell_text(color = "red")
    ),
    locations = cells_body(
      columns = tasmin_cor,
      rows = tasmin_cor < 0.45
    )
  ) %>% 
  tab_style(
    style = list(
      cell_text(color = "red")
    ),
    locations = cells_body(
      columns = tasmax_cor,
      rows = tasmax_cor < 0.45
    )
  ) %>% 
  tab_style(
    style = list(
      cell_text(color = "red")
    ),
    locations = cells_body(
      columns = chisq,
      rows = chisq <= 0.05
    )
  ) %>% 
  tab_spanner("Seasonality", c(ends_with("_plot"), ends_with("cor")), id = "season") %>% 
  tab_spanner("Historical Drought Freq.", c(drought_hist, chisq), id = "hist") %>% 
  cols_label(
    source_id = "Source",
    pr_cor = "pr",
    tas_cor = "tas",
    tasmin_cor = "tasmin",
    tasmax_cor = "tasmax",
    pr_plot = "precipitation",
    tas_plot = "temperature",
    drought_hist = "drought freq.",
    chisq = "Chi-squared"
  ) %>% 
  tab_footnote(
    md("Observed data from [Xavier et al. (2016)](https://doi.org/10.1002/joc.4518)"),
    cells_body(
      columns = source_id,
      rows = source_id == "observed"
    )
  ) %>% 
  tab_footnote("Spearman's rho. Rho < 0.45 highlighted in red.",
               cells_column_spanners("season")) %>% 
  tab_footnote("p-value from Chi-squared goodness-of-fit test comparing frequency of categories of drought to observed.  A smaller p-value means more dissimilar frequencies.",
               cells_column_spanners("hist")) %>% 
  tab_header(title = "Comparison of observed data to CMIP6 'historical' output",
             subtitle = "Data only from 1980 to 2015 to match observed. Results under 'Seasonality' refer to means for each month. Results under 'Historical Drought Freq' use SPEI3 to categorize drought into no drought (blue), mild (yellow), moderate (orange), severe (dark orange), and extreme (red)")
```


# CMIP model details

Below are validation reports and plots of all data downloaded from each CMIP6 source.

```{r plot_fun, include=FALSE}
# Function to plot data
plot_all <- function(data) {
  p_list <- map(c("tas", "pr", "hfls", "hfss", "pet", "spei"),
      ~ggplot(data,
              aes_string(x = "time", y = .x, color = "experiment_id")) +
        geom_line(alpha = 0.5) + 
        geom_smooth(se = FALSE)
  ) 
  patchwork::wrap_plots(p_list, guides = "collect") &
    plot_annotation(title = data$source_id[1])
}
```

<!--> might be possible to generate this programmatically with the help of as_raw_html(gt)? <-->

```{r echo=FALSE}
i=1
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "pr"),
    label = "all required variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp370", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    tas,
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(tas = as.numeric(tas))
  )
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```



```{r echo=FALSE}
i=2
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=3
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=4
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=5
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=6
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=7
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=8
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=9
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=10
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=11
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=12
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=13
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=14
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=15
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


```{r echo=FALSE}
i=16
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```



```{r echo=FALSE}
i=17
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```



```{r echo=FALSE}
i=18
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```



```{r echo=FALSE}
i=19
htmltools::h2(names(df_list[i]))
```
```{r validate=TRUE}
  col_exists(
    df_list[[i]],
    c("hfls", "hfss", "tas", "tasmin", "tasmax", "pr"),
    label = "all variables exist"
    ) 
  col_vals_make_set(
    df_list[[i]],
    experiment_id,
    c("historical", "ssp126", "ssp245", "ssp585"),
    label = "all scenarios exist"
  )
  col_vals_not_null(
    df_list[[i]],
    c(hfls, hfss, tas, tasmin, tasmax, pr),
    label = "no missing values"
  )
  col_vals_expr(
    df_list[[i]],
    ~max(.$pr) > as_units(200, "mm/month"),
    label = "precipitation is reasonable"
  )
  col_vals_between(
    df_list[[i]],
    c(tas, tasmin, tasmax),
    10,
    55,
    label = "temperature is reasonable",
    preconditions = ~. %>% dplyr::mutate(across(starts_with("tas"), as.numeric))
  )
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_all(df_list[[i]])
```


