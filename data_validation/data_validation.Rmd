---
title: "Plot and validate CMIP6 downloads"
knit: (function(input_file, encoding) {
  out_dir <- '../docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
output: 
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(pointblank)
library(tidyverse)
library(here)
library(patchwork)
library(lubridate)
library(tsibble)
library(units)
library(ggforce) #to get ggplot to work with `units`
library(gt)
library(SPEI)
library(glue)
source(here::here("R", "functions.R"))
theme_set(theme_bw())
# Use `validate_rmd()` here to set options for the
# pointblank validation workflow within R Markdown documents
```

```{r load_index, message=FALSE, warning=FALSE, include=FALSE}
idx <- read_csv(here("metadata", "cmip6_index.csv"))
```

# Check that all models were downloaded

Check that all the directories for the .nc files got made

```{r validate=TRUE}
source_dl <- dir(here("data_raw", "CMIP6"))
source_id <- idx$source_id %>% unique() %>% str_to_lower() %>% str_replace_all("-", "_")
stop_if_not(!any(!source_id %in% source_dl))
```

Check that all the corresponding .csv files exist

```{r validate=TRUE}
csvs <- list.files(here('data'))
stop_if_not(!any(!paste0(source_id, "_data.csv") %in% csvs))
```



```{r read_files, message=FALSE, warning=FALSE, include=FALSE}
#read in all files for CMIP6
df_list <-
  map(list.files(here('data'),
                 pattern = "data\\.csv$",
                 full.names = TRUE),
      read_csv) %>%
  set_names(map(., ~.x$source_id[1]))

# observed data
xa_raw <- read_csv(here("data", "xavier_aggregated.csv"))
xa <- 
  xa_raw %>%
  mutate(date = paste(yearmonth, 1) %>% ymd(),
         month = month(date, label = TRUE)) %>% 
  group_by(month) %>%
  summarize(across(c(pr, starts_with("tas")), mean)) %>%
  mutate(pr = set_units(pr, "mm/month"),
         across(starts_with("tas"), ~set_units(.x, "degC")))
```

```{r filter_time, include=FALSE}
#filter so timespan is consistent
df_list <- 
  df_list %>% map(~{
    .x %>% 
      filter((
        experiment_id == "historical" &
          between(
            time,
            ymd_hms("1850-01-01 12:00:00"),
            ymd_hms("2014-12-31 12:00:00")
          )
      ) |
        (
          experiment_id != "historical" &
            between(
              time,
              ymd_hms("2015-01-01 12:00:00"),
              ymd_hms("2100-12-31 12:00:00")
            )
        ))
    
  })
```

```{r convert, include=FALSE}
df_list <- map(df_list, convert_units)
```


# Ensure that all models are complete

For this analysis, I only want to use models with `pr`, `tas`, `hfss`, and `hfls` variables in all 5 scenarios (historical, ssp126, ssp245, ssp370, and ssp585)

```{r include=FALSE}
df_list <- 
  df_list %>%
  keep(~all(c("pr", "tas", "hfss", "hfls") %in% names(.x))) %>% 
  keep(~all(c("historical", "ssp126", "ssp245", "ssp370", "ssp585") %in% .x$experiment_id))
```

# Calculations

Perform necessary calculations to compare PET and SPEI among models and between models and observed.

For PET, I'm using the "energy-only" method proposed by Milly and Dune (2016) eq. 8:

$$
PET = 0.8(R_n - G)
$$

Except that in their notes, they estimate $R_n -G$ as `hfls` + `hfss` after converting to units of mm/day using the latent heat of vaporazation of water, given by their eq. 2:

$$
L_v(T) = 2.501 - 0.002361T
$$
in MJ/kg

```{r pet, include=FALSE}
df_list <- 
  df_list %>%
  map(~ .x %>% mutate(pet = pet_energy_only(hfls, hfss, tas))) %>% 
  #convert PET to mm/month
  map(~.x %>%
        mutate(pet = pet * set_units(days_in_month(time), "d/month"),
               cb = pr - pet)
  )
```

For the observed data and the CMIP6 data from the same period, I calculate 3-month SPEI using precipitation and PET.

```{r spei, include=FALSE}
df_list <- 
  df_list %>%
  map(calc_spei)

#calc spei for observed
xa_spei <-
  xa_raw %>% 
  mutate(cb = pr - eto,
         date = ymd(paste(yearmonth, "15"))) %>% 
  mutate(spei = as.numeric(
    spei(
      ts(cb, freq = 12, start = c(year(min(date)), month(min(date)))),
      scale = 3,
      ref.start = c(1980, 4),
      ref.end = c(2014, 12)
    )$fitted
  ))
```

I calculate drought duration as number of consecutive months with SPEI ≤ -1.  A single drought, therefore, is defined here as a span of consecutive months all with SPEI ≤ -1.

```{r drougt_duration, include=FALSE}
# categorize and count droughts
xa_drought <- 
  calc_drought_duration(xa_spei) %>% 
  add_column(source_id = "observed") %>% 
  dplyr::select(source_id, everything())

cmip_drought <- 
  df_list %>% 
  map_dfr(~.x %>% 
            filter(time <= max(xa_spei$date) & time >= min(xa_spei$date)) %>%  
            calc_drought_duration(),
          .id = "source_id"
  ) 

# join together
cmip_drought <- 
  bind_rows(
  xa_drought,
  cmip_drought
) %>% 
  mutate(source_id = fct_inorder(source_id))


#non-parametric t-tests (wilcoxon rank sum test).  Significant p means different from observed.
pvals <- numeric(nrow(cmip_drought))
for(i in 1:nrow(cmip_drought)) {
  pvals[i] <- wilcox.test(cmip_drought$droughts[[1]], cmip_drought$droughts[[i]])$p.value
}
cmip_drought <- 
  cmip_drought %>%
  add_column(pvals) %>% 
  select(-droughts)
```

# Comparison to Observed Historical

I've ranked the CMIP6 models based on the correlations of monthly precipitation and temperature and the p-value from a non-parametric t-test (Wilcoxon rank sum test) for the mean duration of droughts defined as the nubmer of consecutive months with SPEI ≤ -1. 

```{r message=FALSE, warning=FALSE, include=FALSE}
season_df <- 
  df_list %>% 
  map_dfr(~{.x %>% 
    filter(time >= ymd("1980-01-01") &
             time <= ymd("2015-09-30")) %>% 
      mutate(month = month(time), .after=time) %>% 
      group_by(month) %>% 
      summarize(across(c(pr, starts_with("tas")), mean,
                       .names = "mean_{.col}")) 
  }, .id = "source_id")
```


```{r include=FALSE}
xa2 <- xa %>% 
  rename_with(~paste0("mean_", .), .cols = -month) %>% 
  add_column(source_id = "observed") %>% 
  mutate(month = as.numeric(month))
season_df <- bind_rows(xa2, season_df) %>% 
  #move "observed" to the top by making it the first level
  mutate(source_id = fct_inorder(source_id))
```


```{r mini_plots, include=FALSE}
# Create mini plots of monthly average precip and temperature for table

# season_df$mean_pr %>% range()
# season_df$mean_tasmin %>% min()
# season_df$mean_tasmax %>% max()

season_plots <-
  season_df %>%  
  group_by(source_id) %>%
  nest() %>% 
  mutate(
    pr_season = map(data, ~{
      ggplot(.x, aes(x = month, y = mean_pr)) +
        geom_col(fill = "blue") +
        scale_x_continuous("month", breaks = 1:12,
                           labels = ~month(.x, label = FALSE)) +
        scale_y_unit("pr", limits = c(0, 456)) +
        labs(y = "mm/mon") +
        theme(text = element_text(size = 45))
    }),
    tas_season = map(data, ~{
      ggplot(.x, aes(x = month)) +
        geom_ribbon(aes(ymin = mean_tasmin, ymax = mean_tasmax),
                    fill = "red",
                    alpha = 0.5) +
        geom_line(aes(y = mean_tas), color = "red") +
        scale_x_continuous("month",
                           breaks = 1:12,
                           labels = ~ month(.x, label = FALSE)) +
        scale_y_unit("tas", limits = c(19, 43)) +
        labs(y = "ºC") +
        theme(text = element_text(size = 45))
    })) %>% 
      dplyr::select(-data)
```


```{r table_data, include=FALSE}
table_data <- 
  season_df %>%
  group_by(source_id) %>%
  summarize(
    pr_cor = cor(mean_pr, xa$pr, method = "spearman"),
    tas_cor = cor(mean_tas, xa$tas, method = "spearman"),
    tasmin_cor = cor(mean_tasmin, xa$tasmin, method = "spearman"),
    tasmax_cor = cor(mean_tasmax, xa$tasmax, method = "spearman")
  ) %>%
  full_join(cmip_drought, by = "source_id") %>% 
  #format column for mean ± sd
  mutate(duration = glue("{round(mean_n_mon, 1)}±{round(sd_n_mon, 1)}")) %>% 
  dplyr::select(-mean_n_mon, -sd_n_mon) %>% 
  arrange(
    min_rank(desc(pvals)) +
    min_rank(desc(pr_cor)) +
    min_rank(desc(tas_cor))
    ) %>% 
  full_join(season_plots)
```


```{r gt_rough, include=FALSE}
table_rough <-
  table_data %>% 
  #make columns for plots to go eventually
  mutate(pr_plot = NA,
         tas_plot = NA) %>%
  #make into gt
  gt() %>%
  #place plots
  text_transform(
    locations = cells_body(pr_plot),
    fn = function(x) {
      map(table_data$pr_season,
          ggplot_image,
          height = px(80),
          aspect_ratio = 1.5)
    }
  ) %>% 
  text_transform(
    locations = cells_body(tas_plot),
    fn = function(x) {
      map(table_data$tas_season,
          ggplot_image,
          height = px(80),
          aspect_ratio = 1.5)
    }
  ) %>% 
  cols_hide(ends_with("season")) %>% 
  # round correlations
  fmt_number(ends_with("_cor"))
# table_rough
```

```{r gt_format, echo=FALSE, message=FALSE, warning=FALSE}
table_rough %>% 
  # highlight poor correlations
  tab_style(
    style = list(
      cell_text(color = "red")
    ),
    locations = cells_body(
      columns = pr_cor,
      rows = pr_cor < 0.45
    )
  ) %>% 
    tab_style(
    style = list(
      cell_text(color = "red")
    ),
    locations = cells_body(
      columns = tas_cor,
      rows = tas_cor < 0.45
    )
  )  %>% 
  tab_style(
    style = list(
      cell_text(color = "red")
    ),
    locations = cells_body(
      columns = tasmin_cor,
      rows = tasmin_cor < 0.45
    )
  ) %>% 
  tab_style(
    style = list(
      cell_text(color = "red")
    ),
    locations = cells_body(
      columns = tasmax_cor,
      rows = tasmax_cor < 0.45
    )
  ) %>% 
  #highlight significant p-values for drought duration
  tab_style(
    style = list(
      cell_text(color = "red")
    ),
    locations = cells_body(
      columns = duration,
      rows = pvals < 0.05
    )
  ) %>% 
  tab_spanner("Monthly means", c(ends_with("_plot"), ends_with("cor")), id = "season") %>%
  tab_spanner("Drought duration and frequency", c(duration, n_droughts), id = "droughts") %>%
  cols_label(
    source_id = "Source",
    pr_cor = "pr",
    tas_cor = "tas",
    tasmin_cor = "tasmin",
    tasmax_cor = "tasmax",
    pr_plot = "precipitation",
    tas_plot = "temperature",
    n_droughts = "number",
    duration = "duration (mon) mean ± SD"
  ) %>% 
  cols_hide(pvals) %>% 
  cols_move_to_end(c(duration, n_droughts)) %>% 
  tab_footnote(
    "Red indicates signifcant Wilcoxon rank sum test (p < 0.05).",
    cells_column_labels("duration")
  ) %>% 
  tab_footnote(
    md("Observed data from [Xavier et al. (2016)](https://doi.org/10.1002/joc.4518)"),
    cells_body(
      columns = source_id,
      rows = source_id == "observed"
    )
  ) %>% 
  tab_footnote("Spearman's rho. Rho < 0.45 highlighted in red.",
               cells_column_spanners("season")) %>% 
  tab_header(title = "Comparison of observed data to CMIP6 'historical' output",
             subtitle = "Data only from 1980 to 2015 to match observed.")
```


# CMIP model details

Below are plots of all data downloaded from each CMIP6 source.

```{r plot_fun, include=FALSE}
# Function to plot data
plot_all <- function(data) {
  p_list <- map(c("tas", "pr", "hfls", "hfss", "pet", "spei"),
      ~ggplot(data,
              aes_string(x = "time", y = .x, color = "experiment_id")) +
        geom_line(alpha = 0.5) + 
        geom_smooth(se = FALSE)
  ) 
  patchwork::wrap_plots(p_list, guides = "collect") &
    plot_annotation(title = data$source_id[1])
}
```


```{r echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
for (i in seq_len(length(df_list))) {
  cat('\n')
  cat("## ", names(df_list[i]), "\n")
  p <- plot_all(df_list[[i]])
  print(p)
  cat('\n')
}
```




